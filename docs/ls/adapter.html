<!DOCTYPE html>

<html>
<head>
  <title>adapter.ls</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="_commons.html">
                _commons.ls
              </a>
            
              
              <a class="source" href="adapter.html">
                adapter.ls
              </a>
            
              
              <a class="source" href="frame.html">
                frame.ls
              </a>
            
              
              <a class="source" href="router.html">
                router.ls
              </a>
            
              
              <a class="source" href="state.html">
                state.ls
              </a>
            
              
              <a class="source" href="ui-helpers.html">
                ui-helpers.ls
              </a>
            
              
              <a class="source" href="validation-error-messages.html">
                validation-error-messages.ls
              </a>
            
              
              <a class="source" href="_jade.html">
                _jade.ls
              </a>
            
              
              <a class="source" href="_view.html">
                _view.ls
              </a>
            
              
              <a class="source" href="names.html">
                names.ls
              </a>
            
              
              <a class="source" href="permission.html">
                permission.ls
              </a>
            
              
              <a class="source" href="rule-parser.html">
                rule-parser.ls
              </a>
            
              
              <a class="source" href="rule.html">
                rule.ls
              </a>
            
              
              <a class="source" href="_view.html">
                _view.ls
              </a>
            
              
              <a class="source" href="detail-view.html">
                detail-view.ls
              </a>
            
              
              <a class="source" href="face.html">
                face.ls
              </a>
            
              
              <a class="source" href="list-view.html">
                list-view.ls
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>adapter.ls</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="property">@BP</span> ||= {}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Adpater 本身没有状态，因此可以被多个有相同template的view共用：</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment"># 1）状态保存在view的state里，通过view操作</span>
<span class="class"><span class="keyword">class</span> @<span class="title">BP</span>.<span class="title">Template-adapter</span></span>
  <span class="property">@get</span> = <span class="function"><span class="params">(view)</span>-&gt;</span>
    <span class="keyword">switch</span> view.type
    <span class="reserved">case</span> <span class="string">'list'</span>   <span class="keyword">then</span> <span class="keyword">new</span> List-template-adpater   view
    <span class="reserved">case</span> <span class="string">'detail'</span> <span class="keyword">then</span> <span class="keyword">new</span> Detail-template-adpater view
    <span class="reserved">default</span> <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"type: '#type' is not supported yet."</span>

  <span class="function"><span class="params">(<span class="property">@view</span>)</span>-&gt;</span>
    <span class="property">@template</span> = Template[view.template-name] <span class="comment"># Meteor的template实际上是一个加载template html之后，编译成的函数。也就是说只编译一次，因此不会出现变化。</span>
    <span class="property">@permission</span> = BP.Permission.get-instance! <span class="comment"># permission与view无关，因此可以共用。</span>
    <span class="property">@data-retriever-name</span> = <span class="keyword">if</span> <span class="property">@view</span>.type <span class="keyword">is</span> <span class="string">'list'</span> <span class="keyword">then</span> <span class="property">@view</span>.names.list-data-retriever-name <span class="keyword">else</span> <span class="property">@view</span>.names.detail-data-retriever-name
    <span class="property">@create-helpers</span>!
    <span class="property">@create-renderers</span>!
    <span class="property">@create-event-handlers</span>!
    <span class="property">@template</span>.helpers <span class="property">@helpers</span>
    <span class="property">@template</span>.events <span class="property">@events-handlers</span> 
    <span class="property">@template</span>.rendered = !~&gt; 
      [method.call @ <span class="keyword">for</span> method <span class="keyword">in</span> <span class="property">@renderers</span>]

  <span class="attribute">create-helpers</span>: !<span class="function">-&gt;</span>
    <span class="property">@helpers</span> =
      <span class="string">"bs"</span>                   :  <span class="function"><span class="params">(attr)</span>-&gt;</span> <span class="comment"># 克服Meteor Handlebars不能使用中文key，形如{{中文}}会出错的问题。改用{{bs '中文'}}</span>
                                  <span class="keyword">new</span> Handlebars.Safe-string @[attr] <span class="keyword">if</span> @[attr]
      <span class="string">"bp-permit"</span>            :  <span class="property">@view</span>.<span class="keyword">is</span>-permit
      <span class="string">"bp-attribute-permit"</span>  :  <span class="property">@view</span>.<span class="keyword">is</span>-attribute-permit
      <span class="comment"># "bp-doc-permit"        :  @permission.doc-permission-checker</span>
      <span class="string">"bp-action-is"</span>         :  <span class="property">@view</span>.current-action-checker
      <span class="string">"bp-path-for"</span>          :  ~&gt; <span class="property">@view</span>.get-path.apply <span class="property">@view</span>, &amp;
      <span class="string">'bp-links'</span>             :  <span class="property">@enable-get-links-html-str-for-tooltipster</span>! 

    <span class="property">@helpers</span> &lt;&lt;&lt; <span class="property">@view</span>.data-manager.data-helpers
      <span class="comment"># "#{@data-retriever-name}"       :  ~&gt; @view.data-manager.meteor-template-main-data-helper.apply  @view.data-manager, &amp;</span>

  <span class="attribute">create-renderers</span>: !<span class="function">-&gt;</span> 
    <span class="property">@renderers</span> = [<span class="property">@enable-tooltips</span>]
    <span class="property">@renderers</span> ++= template-ui-post-render-methods <span class="keyword">if</span> template-ui-post-render-methods = <span class="property">@view</span>.add-to-template-rendered!

  <span class="attribute">create-event-handlers</span>: !<span class="function">-&gt;</span> <span class="property">@events-handlers</span> = <span class="property">@view</span>.ui.register-event-handlers!

  <span class="attribute">enable-tooltips</span>: !<span class="function">-&gt;</span> $ <span class="string">'.tooltip'</span> .tooltipster <span class="attribute">interactive</span>: <span class="literal">true</span>

  <span class="attribute">enable-get-links-html-str-for-tooltipster</span>:<span class="function"> -&gt;</span> 
    self = @
    <span class="function"><span class="params">(action, attr, name-attr)</span>-&gt;</span>
      name-attr = <span class="keyword">if</span> <span class="keyword">typeof</span> name-attr <span class="keyword">is</span> <span class="string">'string'</span> <span class="keyword">then</span> name-attr <span class="keyword">else</span> <span class="string">'title'</span>
      result = <span class="string">''</span>
      <span class="keyword">if</span> _.<span class="keyword">is</span>-array docs = @[attr]
        <span class="keyword">for</span> doc <span class="keyword">in</span> docs
          <span class="keyword">if</span> action <span class="keyword">is</span> <span class="string">'test'</span>
            url = <span class="string">'#'</span>
          <span class="keyword">else</span>
            url = self.view.get-path action doc
          result += <span class="string">"&lt;a href='<span class="subst">#{url}</span>'&gt; <span class="subst">#{doc[nameAttr]}</span> &lt;/a&gt;"</span>
          console.log <span class="string">"************* result: "</span>, doc
          console.log <span class="string">"************* name-attr: "</span>, doc[nameAttr]
      <span class="keyword">new</span> Handlebars.Safe-string result 
    
<span class="comment"># ----------------------- Detail ---------------------------------</span>
<span class="class"><span class="keyword">class</span> <span class="title">List-template-adpater</span> <span class="keyword">extends</span> <span class="title">BP</span>.<span class="title">Template-adapter</span></span>


<span class="class"><span class="keyword">class</span> <span class="title">Detail-template-adpater</span> <span class="keyword">extends</span> <span class="title">BP</span>.<span class="title">Template-adapter</span></span>
  <span class="attribute">create-helpers</span>: !<span class="function">-&gt;</span>
    <span class="keyword">super</span> ...
    <span class="property">@helpers</span> &lt;&lt;&lt;
      <span class="string">"bp-auto-insert"</span>        : <span class="property">@add-auto-insert-field</span>
      <span class="string">"bp-pre-link"</span>           : <span class="property">@enable-nav-link</span>(<span class="string">"previous"</span>) 
      <span class="string">"bp-next-link"</span>          : <span class="property">@enable-nav-link</span>(<span class="string">"next"</span>) 
      <span class="string">"bp-add-typeahead"</span>      : <span class="property">@enable-add-typeahead-to-input-field</span>! 
      <span class="string">"bp-add-multi-ahead"</span>    : <span class="property">@enable-add-multi-ahead</span>! 
      <span class="string">"bp-add-html-editor"</span>    : <span class="property">@enable-html-editor-field</span>! 

  <span class="attribute">create-renderers</span>: !<span class="function">-&gt;</span>
    <span class="keyword">super</span> ...
    <span class="property">@renderers</span>.push <span class="property">@view</span>.ui.show-hide-references <span class="comment"># 需要在selector里面写入当前view-name</span>
    <span class="property">@renderers</span>.push <span class="property">@view</span>.ui.add-validation

  <span class="attribute">add-auto-insert-field</span>: !(attr, expression)~&gt;
    console.log <span class="string">"attr: #attr, expression: #expression"</span>
    <span class="property">@view</span>.data-manager.auto-insert-fields[attr] = <span class="attribute">attr</span>: attr, <span class="attribute">expression</span>: expression

  <span class="attribute">enable-nav-link</span>: <span class="function"><span class="params">(nav)</span>-&gt;</span>
    ~&gt;
      <span class="property">@view</span>.get-path action = nav, <span class="keyword">if</span> nav <span class="keyword">is</span> <span class="string">'previous'</span> <span class="keyword">then</span> <span class="property">@view</span>.data-manager.previous-id <span class="keyword">else</span> <span class="property">@view</span>.data-manager.next-id <span class="comment"># 这里需要考虑组合view的情况，要得到整体的path，现在只是局部</span>

  <span class="attribute">enable-add-typeahead-to-input-field</span>:<span class="function"> -&gt;</span> 
    (attr, candidates)!~&gt; <span class="comment"># 模板中的ahead控件将调用它，以便render后，动态添加typeahead功能</span>
      <span class="property">@renderers</span>.push <span class="property">@view</span>.ui.get-typeahead-render <span class="keyword">do</span>
        <span class="attribute">config-name</span>: <span class="property">@view</span>.name + attr <span class="comment">#一个页面可能有多个表单，一个表单有多个typeahead的域</span>
        <span class="attribute">input-name</span>: attr
        <span class="attribute">candidates</span>: candidates

  <span class="attribute">enable-add-multi-ahead</span>:<span class="function"> -&gt;</span>
    (attr, config)!~&gt; <span class="comment"># 模板中的multi-ahead控件将调用它，以便render后，动态添加multi-ahead功能</span>
      <span class="property">@renderers</span>.push <span class="property">@view</span>.ui.get-multi-ahead-render attr, config

  <span class="attribute">enable-html-editor-field</span>:<span class="function"> -&gt;</span>
    (editor-id, toolbar-id, placeholder)!~&gt;
      Meteor.defer<span class="function"> -&gt;</span> <span class="comment"># 这里需要等parentNode就位，如果不defer，parentNode会undefined</span>
        <span class="keyword">new</span> wysihtml5.Editor editor-id, 
          <span class="attribute">toolbar</span>: toolbar-id
          <span class="attribute">parser-rules</span>: wysihtml5-parser-rules
          <span class="attribute">stylesheets</span>: <span class="string">'/lib/wysihtml5/wysihtml5.css'</span>
          <span class="attribute">placeholder-text</span>: placeholder
      <span class="comment"># , 2000</span>




<span class="regexp">/* ------------------------ Private Methods ------------------- */</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
