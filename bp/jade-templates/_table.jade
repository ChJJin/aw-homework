//- ==========  以下为表格，常用于列表（删除、（去）添加、（去）修改）   ==========

//- 用于展示的列表
include _constants-and-utils
include _conditions-and-buttons

mixin table(items, columnNames, attributesNames)
  - var attributesNames = attributesNames ? attributesNames : columnNames
  - rowLinks = [], tableLinks = [], removedLinks = []
  block
  +add-addtional-links(tableLinks)
  if removedLinks.indexOf('go-create') < 0
    +_if-action('list')
      +_guarded-link('go-create')
  table.ui.table.segment
    thead
      +_head-row(columnNames)
    tbody
      +_rows(items, columnNames, attributesNames)


mixin _rows(items, columnNames, attributesNames)
  | {{#each #{items}}}
  +_row(attributesNames)
  | {{/each}}  


mixin _head-row(columnNames)
  tr
    +_each-cell(columnNames)
      th(cols=colIndex) #{cellName}
    +_if-action('list')
      th(cols=colIndex+1) 操作

mixin _row(attributesNames)
  tr
    +_each-cell(attributesNames)
      +_guarded-cell(cellName)
    +_if-action('list')
      +_guarded-operation-cell

mixin _each-cell(cellNames)
  - colIndex = 0
  - cellName = ''
  each cn, i in cellNames
    - colIndex = i
    - cellName = cn
    block

mixin _guarded-cell(attr)
  - var citedDoc = bp.getCitedDoc(attr, cited)
  - var citedClass = citedDoc ? 'cited' : null
  //- +_if-else-attribute-permit(this, attr, 'look')(citedDoc=citedDoc) 不能够view的属性，在query中已经过滤掉了。
  td(cols=colIndex, class=citedClass) 
    != bp.value(attr, cited)
  //- +_else()
  //-   td.cant-look(cols=colIndex)

mixin _guarded-operation-cell()
  td(cols=colIndex+1) 
    +_mark-current-doc-id()
      +_guarded-link('go-update')
      +_guarded-permission-button('delete')
      +add-addtional-links(rowLinks)

//- --------------- 添加links ---------------------------------------------

mixin add-item-link(link)
  - rowLinks.push(link)

mixin add-list-link(link)
  - tableLinks.push(link)

mixin remove-link(link)
  - removedLinks.push(link)
  - removedLinks = removedLinks.unique() 
